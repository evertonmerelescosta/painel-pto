<!DOCTYPE html>
<html lang="pt-br" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle v2.0 - PTO</title>
    <!-- Estilização ultra-leve com Pico.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <!-- Biblioteca do cliente Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Melhorias Visuais v2.0 */
        :root { --font-size: 14px; }
        body { padding: 1.5rem; font-size: var(--font-size); }
        main.container { max-width: 960px; }
        h1, h2, h3, h4, h5, h6 { margin-bottom: 0.75rem; }
        
        /* Módulo de Comando */
        details { border: 1px solid var(--contrast-border); border-radius: var(--border-radius); padding: 1rem; }
        summary { font-weight: bold; cursor: pointer; }
        .form-grid { display: grid; grid-template-columns: 3fr 1fr auto; gap: 1rem; align-items: end; }
        #coleta-status { margin-top: 1rem; font-style: italic; }
        
        /* Painel de Classificação */
        .document-card { padding: 1rem; margin-bottom: 1rem; }
        .document-card header h5 { font-size: 1.1rem; margin: 0; }
        .document-card header small { font-size: 0.8rem; }
        .document-card p { font-size: 0.9rem; margin-top: 0.5rem; }
        .document-card footer { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .document-card footer button, .document-card footer a { padding: 0.5rem 1rem; }
    </style>
</head>
<body>
    <main class="container">
        <header style="text-align: center; margin-bottom: 2rem;">
            <h1>Painel de Controle</h1>
            <p>Projeto Testemunha Ocular</p>
        </header>

        <!-- MÓDULO DE LANÇAMENTO DE COLETA v2.0 -->
        <details>
            <summary>Iniciar Nova Coleta</summary>
            <form id="coleta-form" style="margin-top: 1rem;">
                <div class="form-grid">
                    <label for="query-input">
                        Termos de Busca
                        <input type="text" id="query-input" name="query" placeholder="Ex: &quot;peabiru&quot; arqueologia" required>
                    </label>
                    <label for="pages-input">
                        Páginas
                        <input type="number" id="pages-input" name="pages" value="1" min="1" max="10" required>
                    </label>
                    <button type="submit" id="coleta-submit-btn">Coletar Dados</button>
                </div>
            </form>
            <div id="coleta-status"></div>
        </details>

        <hr>

        <!-- PAINEL DE CLASSIFICAÇÃO -->
        <h2 style="font-size: 1.5rem;">Documentos Pendentes</h2>
        <div id="loading-indicator">
            <p aria-busy="true">Buscando documentos pendentes no repositório...</p>
        </div>
        <div id="documentos-container"></div>
    </main>

    <script>
        // --- CONFIGURAÇÃO ---
        const SUPABASE_URL = 'https://ywvssacobpwxxugyroaz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3dnNzYWNvYnB3eHh1Z3lyb2F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NzA2NzQsImV4cCI6MjA3ODA0NjY3NH0.w-2_YwBvRexBRGCdGJgja8yQPXTYV2mcogGmAXQ9gJs';
        const N8N_WEBHOOK_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/6a4fa3ca-1913-4a78-897a-c0ae88f635d1';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- REFERÊNCIAS DO DOM ---
        const container = document.getElementById('documentos-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const coletaForm = document.getElementById('coleta-form');
        const queryInput = document.getElementById('query-input');
        const pagesInput = document.getElementById('pages-input');
        const coletaSubmitBtn = document.getElementById('coleta-submit-btn');
        const coletaStatus = document.getElementById('coleta-status');

        // --- FUNÇÕES DE COLETA ---
        async function handleColetaSubmit(event) {
            event.preventDefault();
            const query = queryInput.value;
            const pages = parseInt(pagesInput.value, 10);

            coletaSubmitBtn.setAttribute('aria-busy', 'true');
            coletaSubmitBtn.disabled = true;
            coletaStatus.textContent = `Iniciando coleta para "${query}" em ${pages} página(s)...`;
            coletaStatus.style.color = 'var(--secondary)';

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, pages })
                });

                if (!response.ok) throw new Error(`Erro na rede: ${response.statusText}`);
                
                coletaStatus.textContent = 'Coleta disparada com sucesso! Os novos documentos aparecerão em breve.';
                coletaStatus.style.color = 'var(--pico-color-green-500)';
                coletaForm.reset();

            } catch (error) {
                console.error('Erro ao disparar o webhook:', error);
                coletaStatus.textContent = 'Falha ao iniciar a coleta. Verifique o console.';
                coletaStatus.style.color = 'var(--pico-color-red-500)';
            } finally {
                coletaSubmitBtn.removeAttribute('aria-busy');
                coletaSubmitBtn.disabled = false;
                // Aumenta o tempo de espera para dar ao n8n chance de processar tudo
                setTimeout(() => { 
                    coletaStatus.textContent = 'Atualizando lista de documentos...';
                    fetchAndRenderDocuments(); 
                }, 15000);
            }
        }
        
        // --- FUNÇÕES DE CLASSIFICAÇÃO ---
        async function fetchAndRenderDocuments() {
            loadingIndicator.style.display = 'block';
            container.innerHTML = '';
            const { data: documentos, error } = await supabaseClient.from('documentos').select('*').eq('status', 'Pendente').order('criado_em', { ascending: false });
            
            loadingIndicator.style.display = 'none';

            if (error) { 
                console.error('Erro ao buscar documentos:', error); 
                container.innerHTML = `<article><strong>Erro:</strong> Não foi possível carregar os documentos.</article>`; 
                return; 
            }
            if (documentos.length === 0) { 
                container.innerHTML = `<article><p>Nenhum documento pendente para análise.</p></article>`; 
                return; 
            }
            
            documentos.forEach(doc => {
                const docElement = document.createElement('article');
                docElement.classList.add('document-card');
                docElement.setAttribute('data-doc-id', doc.id);
                docElement.innerHTML = `
                    <header>
                        <h5>${doc.titulo}</h5>
                        <small>Ano: ${doc.ano_publicacao || 'N/A'} | Coordenadas: ${doc.contem_coordenadas ? 'Sim' : 'Não'}</small>
                    </header>
                    <p>${doc.resumo}</p>
                    <footer>
                        <a href="${doc.url_fonte}" target="_blank" role="button" class="secondary outline">Abrir Fonte</a>
                        <button class="update-status-btn" data-new-status="Relevante">✓ Relevante</button>
                        <button class="update-status-btn contrast" data-new-status="Descartado">X Descartado</button>
                    </footer>`;
                container.appendChild(docElement);
            });
        }

        async function updateDocumentStatus(id, newStatus) {
            const { error } = await supabaseClient.from('documentos').update({ status: newStatus }).eq('id', id);
            if (error) { 
                console.error(`Erro ao atualizar para ${newStatus}:`, error); 
                alert(`Falha ao atualizar o status.`); 
                return false; 
            }
            return true;
        }

        // --- EVENT LISTENERS ---
        coletaForm.addEventListener('submit', handleColetaSubmit);
        container.addEventListener('click', async (event) => {
            if (event.target.classList.contains('update-status-btn')) {
                const button = event.target;
                const card = button.closest('.document-card');
                const docId = card.getAttribute('data-doc-id');
                const newStatus = button.getAttribute('data-new-status');
                button.setAttribute('aria-busy', 'true');
                const success = await updateDocumentStatus(docId, newStatus);
                if (success) { 
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 300);
                } else { 
                    button.removeAttribute('aria-busy'); 
                }
            }
        });

        // --- INICIALIZAÇÃO ---
        fetchAndRenderDocuments();
    </script>
</body>
</html>
